---
variant: fcos
version: 1.6.0

metadata:
  name: "k8s-worker"

storage:
  files:
    - path: /etc/NetworkManager/system-connections/ens160.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=ens160
          type=ethernet
          interface-name=ens160
          [ipv4]
          method=dhcp
          dns=8.8.8.8;1.1.1.1;
          [ipv6]
          method=ignore

    - path: /etc/wireguard/wg0.conf
      mode: 0600
      contents:
        source: data:text/plain;charset=utf-8;base64,$ENCODED_WG0_CONF_CONTENT
        
    # 워커 노드 초기화 스크립트
    - path: /etc/kubernetes/kubeadm-join.sh
      mode: 0700
      user:
        id: 1000
      group:
        id: 1000
      contents:
        inline: |
          #!/usr/bin/env bash
          set -e

          # 컨테이너 런타임 설정 (containerd)
          cat <<EOF > /etc/containerd/config.toml
          version = 2
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
            runtime_type = "io.containerd.runc.v2"
          EOF

          systemctl restart containerd

          # Kubernetes 클러스터에 조인
          kubeadm join 192.168.222.2:6443 --token <TOKEN> --discovery-token-ca-cert-hash sha256:<HASH>

systemd:
  units:
    - name: NetworkManager.service
      enabled: true
      
    - name: wg-quick@wg0.service
      enabled: true

    # kubeadm join 서비스
    - name: kubeadm-join.service
      enabled: true
      contents: |
        [Unit]
        Description=Join Kubernetes cluster using kubeadm
        After=network-online.target NetworkManager-wait-online.service
        Wants=network-online.target NetworkManager-wait-online.service

        [Service]
        Type=oneshot
        ExecStart=/etc/kubernetes/kubeadm-join.sh
        RemainAfterExit=yes

        [Install]
        WantedBy=multi-user.target

    # kubelet 서비스 설정
    - name: kubelet.service
      enabled: true
      contents: |
        [Unit]
        Description=kubelet: The Kubernetes Node Agent
        Documentation=https://kubernetes.io/docs/home/
        After=containerd.service
        Requires=containerd.service

        [Service]
        ExecStart=/usr/local/bin/kubelet
        Restart=always
        StartLimitInterval=0
        RestartSec=10

        [Install]
        WantedBy=multi-user.target

    # containerd 서비스 설정
    - name: containerd.service
      enabled: true
      contents: |
        [Unit]
        Description=containerd container runtime
        Documentation=https://containerd.io
        After=network-online.target NetworkManager-wait-online.service

        [Service]
        ExecStart=/usr/local/bin/containerd
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

passwd:
  users:
    - name: core
      uid: 1000
      ssh_authorized_keys:
        - $SSH_PUB_KEY