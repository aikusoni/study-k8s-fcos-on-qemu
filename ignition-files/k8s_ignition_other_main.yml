# ignition_join_master_envsubst.yaml
variant: fcos
version: 1.6.0

storage:
  files:
    # 1) JoinConfig 파일을 미리 만들어 둡니다
    - path: /etc/kubeadm-join-config.yaml
      mode: 0644
      contents:
        inline: |
          apiVersion: kubeadm.k8s.io/v1beta4
          kind: JoinConfiguration
          discovery:
            bootstrapToken:
              token: "${JOIN_TOKEN}"
              apiServerEndpoint: "cluster-endpoint:6443"
              caCertHashes:
                - "${DISCOVERY_HASH}"
          controlPlane:
            certificateKey: "${CERT_KEY}"
            localAPIEndpoint:
              advertiseAddress: "{{ .NetworkConfig.AdvertiseAddress }}"
              bindPort: 6443
          nodeRegistration:
            criSocket: unix:///var/run/containerd/containerd.sock

    # 2) systemd unit: kubeadm join --control-plane
    - path: /etc/systemd/system/kubeadm-join.service
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Join this node to the existing control plane
          Wants=containerd.service network-online.target
          After=containerd.service containerd.socket network-online.target

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          Environment="KUBECONFIG=/etc/kubernetes/admin.conf"
          # containerd 준비 대기
          ExecStartPre=/usr/bin/bash -c 'until [ -S /var/run/containerd/containerd.sock ] && ctr version &>/dev/null; do sleep 1; done'
          ExecStart=/usr/local/bin/kubeadm join \
            --config=/etc/kubeadm-join-config.yaml \
            --ignore-preflight-errors=all
          StandardOutput=journal+console
          StandardError=journal+console

          [Install]
          WantedBy=multi-user.target

systemd:
  units:
    # containerd/kubelet 활성화(첫 마스터와 동일)
    - name: containerd.service
      enabled: true
    - name: kubelet.service
      enabled: true

    # kubeadm-join 서비스 활성화
    - name: kubeadm-join.service
      enabled: true

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - $SSH_PUB_KEY