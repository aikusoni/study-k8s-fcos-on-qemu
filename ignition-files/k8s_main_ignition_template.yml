---
variant: fcos
version: 1.6.0

metadata:
  name: "k8s-master"

storage:
  files:
    - path: /etc/NetworkManager/system-connections/ens160.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=ens160
          type=ethernet
          interface-name=ens160
          [ipv4]
          method=dhcp
          dns=8.8.8.8;1.1.1.1;
          [ipv6]
          method=ignore

    - path: /etc/wireguard/wg0.conf
      mode: 0600
      contents:
        source: data:text/plain;charset=utf-8;base64,$ENCODED_WG0_CONF_CONTENT

    # kube
    - path: /usr/local/bin/kubeadm
      mode: 0755
      contents:
        source: https://dl.k8s.io/release/v1.32.0/bin/linux/arm64/kubeadm

    - path: /usr/local/bin/kubectl
      mode: 0755
      contents:
        source: https://dl.k8s.io/release/v1.32.0/bin/linux/arm64/kubectl
        
    - path: /usr/local/bin/kubelet
      mode: 0755
      contents:
        source: https://dl.k8s.io/release/v1.32.0/bin/linux/arm64/kubelet

    - path: /etc/containerd/config.toml
      mode: 0644
      overwrite: true
      contents:
        inline: |
          version = 2
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
            runtime_type = "io.containerd.runc.v2"
            
    - path: /etc/modules-load.d/br_netfilter.conf
      mode: 0644
      overwrite: true
      contents:
        inline: br_netfilter

    - path: /etc/sysctl.d/kubernetes.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          net.bridge.bridge-nf-call-iptables=1
          net.ipv4.ip_forward=1

systemd:
  units:
    - name: NetworkManager.service
      enabled: true
      
    - name: wg-quick@wg0.service
      enabled: true

    # kubelet 서비스 설정
    - name: kubelet.service
      enabled: true
      contents: |
        [Unit]
        Description=kubelet: The Kubernetes Node Agent
        Documentation=https://kubernetes.io/docs/home/
        After=containerd.service
        Requires=containerd.service

        [Service]
        User=root
        ExecStart=/usr/local/bin/kubelet
        Restart=always
        StartLimitInterval=0
        RestartSec=10

        [Install]
        WantedBy=multi-user.target

    # containerd 서비스 설정
    - name: containerd.service
      enabled: true
      contents: |
        [Unit]
        Description=containerd container runtime
        Documentation=https://containerd.io
        After=network-online.target NetworkManager-wait-online.service

        [Service]
        User=root
        ExecStart=/usr/bin/containerd
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target
passwd:
  users:
    - name: core
      uid: 1000
      ssh_authorized_keys:
        - $SSH_PUB_KEY